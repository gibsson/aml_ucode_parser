commit 27f94fbd6d1e6f1958648b6ece5e35b28b9e907c
Author: Hui Zhang <hui.zhang@amlogic.com>
Date:   Wed Apr 3 10:12:56 2019 +0800

    vh264: fix channel switching system hangup issue in vh264 remove  [1/1]
    
    PD#SWPL-6377
    
    Problem:
    hw bus dead lock in h264 remove.
    
    Solution:
    wait for decoder hw stopped completely before h264 remove
    
    Verify:
    X301
    
    Change-Id: Ia3555e687ecfe452948922d3e221c0fae0ad499d
    Signed-off-by: Hui Zhang <hui.zhang@amlogic.com>

diff --git a/drivers/frame_provider/decoder/h264/vh264.c b/drivers/frame_provider/decoder/h264/vh264.c
index 1781bb7..f5be8ed 100644
--- a/drivers/frame_provider/decoder/h264/vh264.c
+++ b/drivers/frame_provider/decoder/h264/vh264.c
@@ -3712,11 +3712,10 @@ static int amvdec_h264_remove(struct platform_device *pdev)
 	cancel_work_sync(&notify_work);
 	cancel_work_sync(&set_clk_work);
 	cancel_work_sync(&userdata_push_work);
-
-	mutex_lock(&vh264_mutex);
 	vh264_stop(MODE_FULL);
+	wait_vh264_search_done();
+	mutex_lock(&vh264_mutex);
 	vdec_source_changed(VFORMAT_H264, 0, 0, 0);
-
 #ifdef DUMP_USER_DATA
 	vh264_dump_userdata();
 #endif

commit cebc42a9d9ffdaaa32a2105b0d0b068f36b7282e
Author: Zhiqiang Han <zhiqiang.han@amlogic.com>
Date:   Tue Feb 26 13:50:33 2019 +0800

    dvb: export bit32 of pts value for audio/video [1/2]
    
    PD#SWPL-5160
    
    Problem:
    not standard pts value which should be a 33bit value
    
    Solution:
    added bit32 exporting
    
    Verify:
    Local build on R314
    
    Change-Id: I0776251894b604601e64faf81e68b40255d812f4
    Signed-off-by: Zhiqiang Han <zhiqiang.han@amlogic.com>

diff --git a/drivers/stream_input/parser/hw_demux/aml_dmx.c b/drivers/stream_input/parser/hw_demux/aml_dmx.c
index 378d996..20fdd3d 100644
--- a/drivers/stream_input/parser/hw_demux/aml_dmx.c
+++ b/drivers/stream_input/parser/hw_demux/aml_dmx.c
@@ -439,6 +439,8 @@ static int dmx_timeout_set(struct aml_dmxtimeout *dto, int enable,
 /*Audio & Video PTS value*/
 static u32 video_pts;
 static u32 audio_pts;
+static u32 video_pts_bit32;
+static u32 audio_pts_bit32;
 static u32 first_video_pts;
 static u32 first_audio_pts;
 static int demux_skipbyte;
@@ -1311,6 +1313,8 @@ static irqreturn_t dmx_irq_handler(int irq_number, void *para)
 
 		if (pdts_status & (1 << VIDEO_PTS_READY)) {
 			video_pts = DMX_READ_REG(dmx->id, VIDEO_PTS_DEMUX);
+			video_pts_bit32 =
+				(status & (1 << VIDEO_PTS_BIT32)) ? 1 : 0;
 			if (!first_video_pts
 			    || 0 > (int)(video_pts - first_video_pts))
 				first_video_pts = video_pts;
@@ -1318,6 +1322,8 @@ static irqreturn_t dmx_irq_handler(int irq_number, void *para)
 
 		if (pdts_status & (1 << AUDIO_PTS_READY)) {
 			audio_pts = DMX_READ_REG(dmx->id, AUDIO_PTS_DEMUX);
+			audio_pts_bit32 =
+				(status & (1 << AUDIO_PTS_BIT32)) ? 1 : 0;
 			if (!first_audio_pts
 			    || 0 > (int)(audio_pts - first_audio_pts))
 				first_audio_pts = audio_pts;
@@ -5038,6 +5044,29 @@ u32 aml_dmx_get_audio_pts(struct aml_dvb *dvb)
 	return pts;
 }
 
+u32 aml_dmx_get_video_pts_bit32(struct aml_dvb *dvb)
+{
+	unsigned long flags;
+	u32 bit32;
+
+	spin_lock_irqsave(&dvb->slock, flags);
+	bit32 = video_pts_bit32;
+	spin_unlock_irqrestore(&dvb->slock, flags);
+
+	return bit32;
+}
+
+u32 aml_dmx_get_audio_pts_bit32(struct aml_dvb *dvb)
+{
+	unsigned long flags;
+	u32 bit32;
+
+	spin_lock_irqsave(&dvb->slock, flags);
+	bit32 = audio_pts_bit32;
+	spin_unlock_irqrestore(&dvb->slock, flags);
+
+	return bit32;
+}
 u32 aml_dmx_get_first_video_pts(struct aml_dvb *dvb)
 {
 	unsigned long flags;
diff --git a/drivers/stream_input/parser/hw_demux/aml_dvb.c b/drivers/stream_input/parser/hw_demux/aml_dvb.c
index f737b21..767135d 100644
--- a/drivers/stream_input/parser/hw_demux/aml_dvb.c
+++ b/drivers/stream_input/parser/hw_demux/aml_dvb.c
@@ -1483,6 +1483,31 @@ static ssize_t demux_show_audio_pts(struct class *class,
 	return ret;
 }
 
+/*Show the Video PTS bit32 value*/
+static ssize_t demux_show_video_pts_bit32(struct class *class,
+				struct class_attribute *attr, char *buf)
+{
+	struct aml_dvb *dvb = &aml_dvb_device;
+	ssize_t ret = 0;
+
+	ret = sprintf(buf, "%u\n", aml_dmx_get_video_pts_bit32(dvb));
+
+	return ret;
+}
+
+/*Show the Audio PTS bit32 value*/
+static ssize_t demux_show_audio_pts_bit32(struct class *class,
+				struct class_attribute *attr, char *buf)
+{
+	struct aml_dvb *dvb = &aml_dvb_device;
+	ssize_t ret = 0;
+
+	ret = sprintf(buf, "%u\n", aml_dmx_get_audio_pts_bit32(dvb));
+
+	return ret;
+}
+
+
 /*Show the First Video PTS value*/
 static ssize_t demux_show_first_video_pts(struct class *class,
 					  struct class_attribute *attr,
@@ -1710,6 +1735,8 @@ static struct class_attribute aml_stb_class_attrs[] = {
 	       NULL),
 	__ATTR(audio_pts, 0664, demux_show_audio_pts,
 	       NULL),
+	__ATTR(video_pts_bit32, 0644, demux_show_video_pts_bit32, NULL),
+	__ATTR(audio_pts_bit32, 0644, demux_show_audio_pts_bit32, NULL),
 	__ATTR(first_video_pts, 0644, demux_show_first_video_pts,
 	       NULL),
 	__ATTR(first_audio_pts, 0644, demux_show_first_audio_pts,
diff --git a/drivers/stream_input/parser/hw_demux/aml_dvb.h b/drivers/stream_input/parser/hw_demux/aml_dvb.h
index 76414a3..9fc82ba 100644
--- a/drivers/stream_input/parser/hw_demux/aml_dvb.h
+++ b/drivers/stream_input/parser/hw_demux/aml_dvb.h
@@ -356,6 +356,8 @@ extern int aml_asyncfifo_hw_reset(struct aml_asyncfifo *afifo);
 /*Get the Audio & Video PTS*/
 extern u32 aml_dmx_get_video_pts(struct aml_dvb *dvb);
 extern u32 aml_dmx_get_audio_pts(struct aml_dvb *dvb);
+extern u32 aml_dmx_get_video_pts_bit32(struct aml_dvb *dvb);
+extern u32 aml_dmx_get_audio_pts_bit32(struct aml_dvb *dvb);
 extern u32 aml_dmx_get_first_video_pts(struct aml_dvb *dvb);
 extern u32 aml_dmx_get_first_audio_pts(struct aml_dvb *dvb);
 

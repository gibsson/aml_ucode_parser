commit 5c363baa3a7855aee272eedf5094ef959df43420
Author: shihong.zheng <shihong.zheng@amlogic.com>
Date:   Thu May 9 10:24:43 2019 +0800

    userdata: fix a crash problem when reset userdata fifo. [1/1]
    
    PD#OTT-3218
    
    Problem:
    crash when unreg, instance may be release.
    PC is at vmh264_reset_userdata_fifo+0x5c/0x74 [amvdec_mh264]
    LR is at wake_up_klogd+0x8c/0xb8.
    
    Solution:
    mutex_lock to avoid concurrence with release.
    
    Verify:
    S905X2-U212
    
    Change-Id: Ia46b7dcedc106ee852c329727c0fb431d1f7e45f
    Signed-off-by: shihong.zheng <shihong.zheng@amlogic.com>

diff --git a/drivers/stream_input/amports/amstream.c b/drivers/stream_input/amports/amstream.c
index 5bfdb00..765502c 100644
--- a/drivers/stream_input/amports/amstream.c
+++ b/drivers/stream_input/amports/amstream.c
@@ -3123,12 +3123,14 @@ static long amstream_do_ioctl_old(struct port_priv_s *priv,
 			struct vdec_s *vdec;
 			int vdec_id;
 
+			mutex_lock(&amstream_mutex);
 			get_user(vdec_id, (int __user *)arg);
 			vdec = vdec_get_vdec_by_id(vdec_id);
 			if (vdec) {
 				vdec_reset_userdata_fifo(vdec, 0);
 				pr_info("reset_userdata_fifo for vdec: %d\n", vdec_id);
 			}
+			mutex_unlock(&amstream_mutex);
 		} else
 			r = -EINVAL;
 		break;

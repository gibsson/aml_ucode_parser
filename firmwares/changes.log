commit 52a31dc3d4e72f2a70595624786e6fc969838b55
Author: Nanxin Qin <nanxin.qin@amlogic.com>
Date:   Thu Jun 6 13:33:58 2019 +0800

    vdec: fixed the playback with h263. [1/1]
    
    PD#SWPL-9467
    
    Problem:
    fixed the playback with h263
    
    Solution:
    fixed the playback with h263
    
    Verify:
    U212
    
    Change-Id: I24a0c0817503c65ed64e0c21e3c3ca70d189921c
    Signed-off-by: Nanxin Qin <nanxin.qin@amlogic.com>

diff --git a/drivers/frame_provider/decoder/utils/vdec.c b/drivers/frame_provider/decoder/utils/vdec.c
index 089c235..bb8edab 100644
--- a/drivers/frame_provider/decoder/utils/vdec.c
+++ b/drivers/frame_provider/decoder/utils/vdec.c
@@ -909,6 +909,22 @@ int vdec_set_decinfo(struct vdec_s *vdec, struct dec_sysinfo *p)
 		sizeof(struct dec_sysinfo)))
 		return -EFAULT;
 
+	/* force switch to mult instance if supports this profile. */
+	if ((vdec->type == VDEC_TYPE_SINGLE) &&
+		!disable_switch_single_to_mult) {
+		const char *str = NULL;
+		char fmt[16] = {0};
+
+		str = strchr(get_dev_name(false, vdec->format), '_');
+		if (!str)
+			return -1;
+
+		sprintf(fmt, "m%s", ++str);
+		if (is_support_profile(fmt) &&
+			vdec->sys_info->format != VIDEO_DEC_FORMAT_H263)
+			vdec->type = VDEC_TYPE_STREAM_PARSER;
+	}
+
 	return 0;
 }
 EXPORT_SYMBOL(vdec_set_decinfo);
@@ -974,21 +990,6 @@ int vdec_set_format(struct vdec_s *vdec, int format)
 		vdec->slave->format = format;
 		vdec->slave->port_flag |= PORT_FLAG_VFORMAT;
 	}
-
-	/* force switch to mult instance if supports this profile. */
-	if ((vdec->type == VDEC_TYPE_SINGLE) &&
-		!disable_switch_single_to_mult) {
-		const char *str = NULL;
-		char fmt[16] = {0};
-
-		str = strchr(get_dev_name(false, format), '_');
-		if (!str)
-			return -1;
-
-		sprintf(fmt, "m%s", ++str);
-		if (is_support_profile(fmt))
-			vdec->type = VDEC_TYPE_STREAM_PARSER;
-	}
 	//trace_vdec_set_format(vdec, format);/*DEBUG_TMP*/
 
 	return 0;

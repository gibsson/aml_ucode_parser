commit 500f055993471283af760f7c2097e3e9a1817dad
Author: shihong.zheng <shihong.zheng@amlogic.com>
Date:   Mon Jul 1 16:48:43 2019 +0800

    mh264: fix h264 aspect ratio error. [1/1]
    
    PD#SWPL-10327
    
    Problem:
    h264 multi intance aspect ratio wrong.
    aspect ratio is calc in back end now. in vui_config func,
    no calculation about h264_ar in most case, just set it to 0x3ff.
    when dtv get it from vdecstat by ioctl, aspect ratio will be wrong.
    
    Solution:.
    porting the calculation of aspect ratio to vdec_status
    from single mode.
    
    Verify:
    x301
    
    Change-Id: Ib8e44b0995f46d18c30d202d6c17faefe6e2257f
    Signed-off-by: shihong.zheng <shihong.zheng@amlogic.com>

diff --git a/drivers/frame_provider/decoder/h264_multi/vmh264.c b/drivers/frame_provider/decoder/h264_multi/vmh264.c
index 1166a70..ab81fea 100644
--- a/drivers/frame_provider/decoder/h264_multi/vmh264.c
+++ b/drivers/frame_provider/decoder/h264_multi/vmh264.c
@@ -6437,6 +6437,10 @@ static int dec_status(struct vdec_s *vdec, struct vdec_info *vstatus)
 		vstatus->frame_rate = -1;
 	vstatus->error_count = 0;
 	vstatus->status = hw->stat;
+	if (hw->h264_ar == 0x3ff)
+		hw->h264_ar = (0x100 *
+			hw->frame_height * hw->height_aspect_ratio) /
+			(hw->frame_width * hw->width_aspect_ratio);
 	ar = min_t(u32,
 			hw->h264_ar,
 			DISP_RATIO_ASPECT_RATIO_MAX);
diff --git a/drivers/frame_provider/decoder/utils/vdec.c b/drivers/frame_provider/decoder/utils/vdec.c
index 4f5ca65..3694b8e 100644
--- a/drivers/frame_provider/decoder/utils/vdec.c
+++ b/drivers/frame_provider/decoder/utils/vdec.c
@@ -4617,10 +4617,10 @@ static ssize_t vdec_status_show(struct class *class,
 				"%13s : %u\n", "hw err count",
 				vs.error_count);
 			pbuf += sprintf(pbuf,
-				"%13s : %llu %s\n\n", "total data",
+				"%13s : %llu %s\n", "total data",
 				vs.total_data / 1024, "KB");
 			pbuf += sprintf(pbuf,
-				"%13s : %x\n", "ratio_control",
+				"%13s : %x\n\n", "ratio_control",
 				vs.ratio_control);
 
 			vdec_num++;

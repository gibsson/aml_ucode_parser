commit cc08fcc6478f95d89329bc867776f039527afcbf
Author: kunpeng.tang <kunpeng.tang@amlogic.com>
Date:   Wed Jun 26 15:11:05 2019 +0800

    Encoder: Add qp mode interface [1/2]
    
    PD#OPS-665
    
    Problem:
    The es stream comes from h.264 encoder is not consistency
    
    Solution:
    Add qp mode interface,it could set quant to limit range,
    beyond this issue,may be needed in the future
    
    Verify:
    U212
    
    Change-Id: Ic454f94e9d3eb8d6c2463e6d3081234f55cb6541
    Signed-off-by: kunpeng.tang <kunpeng.tang@amlogic.com>

diff --git a/drivers/frame_sink/encoder/h264/encoder.c b/drivers/frame_sink/encoder/h264/encoder.c
index 2295bc3..1d2b96e 100644
--- a/drivers/frame_sink/encoder/h264/encoder.c
+++ b/drivers/frame_sink/encoder/h264/encoder.c
@@ -184,6 +184,7 @@ static unsigned int c_snr_gau_alp0_max = 63;
 static unsigned int c_bld_beta2alp_rate = 16;
 static unsigned int c_bld_beta_min;
 static unsigned int c_bld_beta_max = 63;
+static unsigned int qp_mode;
 
 static DEFINE_SPINLOCK(lock);
 
@@ -2159,8 +2160,13 @@ static void avc_prot_init(struct encode_wq_s *wq,
 		WRITE_HREG(HCODEC_V5_SMALL_DIFF_CNT,
 			(v5_small_diff_C<<16) |
 			(v5_small_diff_Y<<0));
-		WRITE_HREG(HCODEC_V5_SIMPLE_MB_DQUANT,
-			v5_simple_dq_setting);
+		if (qp_mode == 1) {
+			WRITE_HREG(HCODEC_V5_SIMPLE_MB_DQUANT,
+				0);
+		} else {
+			WRITE_HREG(HCODEC_V5_SIMPLE_MB_DQUANT,
+				v5_simple_dq_setting);
+		}
 		WRITE_HREG(HCODEC_V5_SIMPLE_MB_ME_WEIGHT,
 			v5_simple_me_weight_setting);
 		/* txlx can remove it */
@@ -3292,6 +3298,10 @@ static long amvenc_avc_ioctl(struct file *file, u32 cmd, ulong arg)
 	case AMVENC_AVC_IOC_MAX_INSTANCE:
 		put_user(encode_manager.max_instance, (u32 *)arg);
 		break;
+	case AMVENC_AVC_IOC_QP_MODE:
+		get_user(qp_mode, ((u32 *)arg));
+		pr_info("qp_mode %d\n", qp_mode);
+		break;
 	default:
 		r = -1;
 		break;
diff --git a/drivers/frame_sink/encoder/h264/encoder.h b/drivers/frame_sink/encoder/h264/encoder.h
index 39a3c1e..e47fa39 100644
--- a/drivers/frame_sink/encoder/h264/encoder.h
+++ b/drivers/frame_sink/encoder/h264/encoder.h
@@ -123,6 +123,8 @@
 #define AMVENC_AVC_IOC_GET_BUFFINFO _IOW(AMVENC_AVC_IOC_MAGIC, 0x08, u32)
 #define AMVENC_AVC_IOC_SUBMIT	_IOW(AMVENC_AVC_IOC_MAGIC, 0x09, u32)
 #define AMVENC_AVC_IOC_READ_CANVAS _IOW(AMVENC_AVC_IOC_MAGIC, 0x0a, u32)
+#define AMVENC_AVC_IOC_QP_MODE _IOW(AMVENC_AVC_IOC_MAGIC, 0x0b, u32)
+
 
 
 #define IE_PIPPELINE_BLOCK_SHIFT 0

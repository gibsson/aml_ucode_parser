commit 3c33af4cd0b10e47a4f8aba03c7035eb7f01ea70
Author: Nanxin Qin <nanxin.qin@amlogic.com>
Date:   Tue May 28 21:33:24 2019 +0800

    module: fixed playback stuck issue [1/1]
    
    PD#SWPL-8890
    
    Problem:
    playback stuck when full format playback test.
    
    Solution:
    The counter becomes negative due to the incorrect
    shutdown of the hevc core, which affects the decoding
    schedule and causes stuck.Modifying the code logic
    to fixes this issue.
    
    Verify:
    verified on x301
    
    Change-Id: I62c5ce90849e4f54d37cfd9b587a16b06d80f2b6
    Signed-off-by: Nanxin Qin <nanxin.qin@amlogic.com>

diff --git a/drivers/stream_input/amports/amstream.c b/drivers/stream_input/amports/amstream.c
index 765502c..3683586 100644
--- a/drivers/stream_input/amports/amstream.c
+++ b/drivers/stream_input/amports/amstream.c
@@ -1764,8 +1764,10 @@ static int amstream_release(struct inode *inode, struct file *file)
 #else
 			if (get_cpu_major_id() >= AM_MESON_CPU_MAJOR_ID_TXLX
 				&& port->vformat == VFORMAT_H264
-				&& bufs[BUF_TYPE_VIDEO].for_4k)
+				&& bufs[BUF_TYPE_VIDEO].for_4k) {
 				vdec_poweroff(VDEC_HEVC);
+				bufs[BUF_TYPE_VIDEO].for_4k = 0;
+			}
 
 			if ((port->vformat == VFORMAT_HEVC
 					|| port->vformat == VFORMAT_AVS2
